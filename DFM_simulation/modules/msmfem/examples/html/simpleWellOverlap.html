
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>simpleWellOverlap</title><meta name="generator" content="MATLAB 7.13"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2012-12-19"><meta name="DC.source" content="simpleWellOverlap.m"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">Multiscale Pressure Solver with Overlap:</a></li><li><a href="#2">What is overlap?</a></li><li><a href="#3">Define and visualize the model</a></li><li><a href="#4">Partition the grid and compute mimetic innerproduct</a></li><li><a href="#5">Generate coarse well system with overlap around the well</a></li><li><a href="#6">Solve the global flow problems</a></li><li><a href="#7">Plot solution</a></li></ul></div><h2>Multiscale Pressure Solver with Overlap:<a name="1"></a></h2><p>Use overlap in multiscale basis function to improve accuracy of the simulation.  We compare the fine-grid pressure solver and multiscale pressure solvers with and without overlap by solving the single-phase pressure equation</p><p><img src="simpleWellOverlap_eq25293.png" alt="$$\nabla\cdot v = q, \qquad v=\textbf{--}\frac{K}{\mu}\nabla p,$$"></p><p>for a Cartesian grid with anisotropic, homogeneous permeability.</p><p>This example shows the use of overlap around the well.</p><pre class="codeinput">require <span class="string">coarsegrid</span>
</pre><h2>What is overlap?<a name="2"></a></h2><p>Overlap means that we extend the support of the multiscale basis functions, that is, we include more fine cells when computing the basis function. Using overlapping domains enables capturing more complex flow patterns, particularly for very coarse grids, at the expense of increased coupling in the resulting systems of linear equations. The use of overlap is particularly attractive in cases of highly heterogeneous reservoirs of cases where wells are placed near the corner of a coarse well-block. In the following, we describe the different types of overlap implemented in the Matlab Reservoir Simulation Toolbox. Let the thick lines be the coarse grid, the thin lines represent the fine grid, the shaded region the overlap (of fine cells), and the red circle be the well.</p><p>Overlap in the reservoir basis function for a coarse face ij means that we include fine cells around the the neighboring coarse blocks when we compute the basis for face ij:</p><p><img vspace="5" hspace="5" src="basisIJ.png" alt=""> </p><p>The flow near a well is described by a multiscale well basis. This basis normally only has support in the coarse well-block. If the well lies close to the corner of the well-block, this will be a poor description of the flow near the well because it will not describe the flow over the corner. In such cases we can use overlap around the well ('overlapWell'), here shown in different colors with increasing number of overlap:</p><p><img vspace="5" hspace="5" src="basisOverlapWell.png" alt=""> </p><p>In some cases (e.g in case of highly hetereogeneous permeability) it might be necessary to use overlap around the entire well block ('OverlapBlock'):</p><p><img vspace="5" hspace="5" src="basisOverlapBlock.png" alt=""> </p><h2>Define and visualize the model<a name="3"></a></h2><p>We set up a simple 40-by-40-by-2 cartesian grid model with anisotropic, homogeneous permeability and assume that the reservoir is filled with a single fluid (with default values).</p><pre class="codeinput">G         = cartGrid([40, 40, 2]);
G         = computeGeometry(G);
diag_k    = [500, 500, 50] .* milli*darcy;
rock.perm = repmat(diag_k, [G.cells.num, 1]);
fluid     = initSingleFluid(<span class="string">'mu'</span> ,    1*centi*poise     , <span class="keyword">...</span>
                            <span class="string">'rho'</span>, 1014*kilogram/meter^3);

gravity <span class="string">off</span>

<span class="comment">% Set two vertical wells.</span>
W = verticalWell([], G, rock,  8,  8, 1:G.cartDims(3), <span class="keyword">...</span>
                 <span class="string">'Type'</span>, <span class="string">'rate'</span>, <span class="string">'Val'</span>, 1*meter^3/day, <span class="keyword">...</span>
                 <span class="string">'Radius'</span>, 0.1, <span class="string">'Comp_i'</span>, [1, 0]);
W = verticalWell(W , G, rock, 33, 33, 1:G.cartDims(3), <span class="keyword">...</span>
                 <span class="string">'Type'</span>, <span class="string">'bhp'</span>, <span class="string">'Val'</span>, 0, <span class="string">'Radius'</span>, 0.1, <span class="string">'Comp_i'</span>, [0, 1]);
</pre><h2>Partition the grid and compute mimetic innerproduct<a name="4"></a></h2><p>We partition the fine grid uniformly into 5-by-5-by-1 blocks using no overlap in the basis reservoir basis functions.</p><pre class="codeinput">part = partitionCartGrid(G.cartDims, [5, 5, 1]);
CG   = generateCoarseGrid(G, part);
S    = computeMimeticIP(G, rock);

<span class="comment">% Note: Only use overlap around wells, not in reservoir basisfunctions</span>
mu  = fluid.properties(initResSol(G, 0.0));
kr  = fluid.relperm(ones([G.cells.num, 1]), initResSol(G, 0.0));
mob = kr ./ mu;
CS  = generateCoarseSystem(G, rock, S, CG, mob, <span class="string">'Overlap'</span>, 0);

clf,
   plotCellData(G, mod(part,2), <span class="string">'EdgeColor'</span>, <span class="string">'k'</span>);
   outlineCoarseGrid(G, part, <span class="string">'LineWidth'</span>, 3);
   plotWell(G, W, <span class="string">'radius'</span>, 0.1, <span class="string">'height'</span>, 2);
   view(3), axis <span class="string">tight</span> <span class="string">off</span>
</pre><img vspace="5" hspace="5" src="simpleWellOverlap_01.png" alt=""> <h2>Generate coarse well system with overlap around the well<a name="5"></a></h2><p>As can be seen from the plot of the model, the wells are near a corner of their supporting coarse blocks, which may lead to highly inaccurate results (as we will see shortly). To impreove the accuracy, we can introduce onverlap in the well basis functions. As pointed out above, we have two different choices: 'OverlapWell' and 'OverlapBlock'. The first includes cells around the well and the latter includes cells around the well-block (the coarse block containing the well). We apply overlap around the well for 'W1' and use no overlap for 'W' as a reference.</p><pre class="codeinput">W1 = W;

<span class="comment">% First no overlap</span>
W  = generateCoarseWellSystem(G, S, CG, CS, mob, rock, W, <span class="keyword">...</span>
                              <span class="string">'OverlapWell'</span>,  0, <span class="string">'OverlapBlock'</span>, 0);
<span class="comment">% Then overlap around well</span>
W1 = generateCoarseWellSystem(G, S, CG, CS, mob, rock, W1, <span class="keyword">...</span>
                              <span class="string">'OverlapWell'</span>, 10, <span class="string">'OverlapBlock'</span>, 0);
</pre><h2>Solve the global flow problems<a name="6"></a></h2><pre>The mass matrix B in the linear system will not be block-diagonal when
we use overlap. Thus, the lineary system system can not be reduced by
Schur-complement reduction as we do in the hybrid solver. Therefore, the
coarse system with overlap must be solved with option 'Solver', 'mixed'
as input to solveIncompFlowMS.</pre><pre class="codeinput"><span class="comment">% Fine scale reference solution:</span>
ref = initState(G, W, 0, [0, 1]);
ref = solveIncompFlow(ref, G, S, fluid, <span class="string">'wells'</span>, W);

<span class="comment">% Coarse scale - no overlap:</span>
s = initState(G, W, 0, [1, 0]);
s = solveIncompFlowMS(s,  G, CG, part, S, CS, fluid, <span class="keyword">...</span>
                      <span class="string">'wells'</span>, W, <span class="string">'Solver'</span>, <span class="string">'mixed'</span>);

<span class="comment">% Coarse scale - overlap:</span>
s1 = initState(G, W, 0, [1, 0]);
s1 = solveIncompFlowMS(s1, G, CG, part, S, CS, fluid, <span class="keyword">...</span>
                       <span class="string">'wells'</span>, W1, <span class="string">'Solver'</span>, <span class="string">'mixed'</span>);

<span class="comment">% Report pressure drop between wells.</span>
dp = @(x) num2str(convertTo(x.wellSol(1).pressure, barsa()));
disp([<span class="string">'DeltaP - Fine:          '</span>, dp(ref)])
disp([<span class="string">'DeltaP - Ms no overlap: '</span>, dp(s  )])
disp([<span class="string">'DeltaP - Ms overlap:    '</span>, dp(s1 )])
</pre><pre class="codeoutput">DeltaP - Fine:          0.14281
DeltaP - Ms no overlap: 0.19516
DeltaP - Ms overlap:    0.14472
</pre><h2>Plot solution<a name="7"></a></h2><pre class="codeinput">cellNo    = rldecode(1 : G.cells.num, diff(G.cells.facePos), 2) .';
diverg    = @(v) accumarray(cellNo, abs(convertTo(v, meter^3/day)));
plot_flux = @(x) plotCellData(G, diverg(x));
well_bas  = @(w) S.BI * sparse(w.CS.basis{1}{1}, 1, w.CS.basis{1}{3}, <span class="keyword">...</span>
                               size(G.cells.faces,1), 1);

subplot(2,3,1)
   plot_flux(ref.flux(G.cells.faces(:,1)));
   title(<span class="string">'Flux - fine scale'</span>); cx = caxis;

subplot(2,3,2)
   plot_flux(s.flux(G.cells.faces(:,1)))  ;
   title(<span class="string">'Flux - no overlap'</span>); caxis(cx)

subplot(2,3,3)
   plot_flux(s1.flux(G.cells.faces(:,1))) ;
   title(<span class="string">'Flux - overlap'</span>)   ; caxis(cx)

subplot(2,3,5)
   plot_flux(well_bas(W(1)));
   axis([0, 20, 0, 20]);  cx = caxis;
   title(<span class="string">'Well basis - no overlap'</span>)

subplot(2,3,6)
   plot_flux(well_bas(W1(1)));
   axis([0, 20, 0, 20]); caxis(cx);
   title(<span class="string">'Well basis - overlap'</span>)
</pre><img vspace="5" hspace="5" src="simpleWellOverlap_02.png" alt=""> <p class="footer"><br>
      Published with MATLAB&reg; 7.13<br></p></div><!--
##### SOURCE BEGIN #####
%% Multiscale Pressure Solver with Overlap:
% Use overlap in multiscale basis function to improve accuracy of the
% simulation.  We compare the fine-grid pressure solver and multiscale
% pressure solvers with and without overlap by solving the single-phase
% pressure equation
%
% $$\nabla\cdot v = q, \qquad v=\textbf{REPLACE_WITH_DASH_DASH}\frac{K}{\mu}\nabla p,$$
%
% for a Cartesian grid with anisotropic, homogeneous permeability.
%
% This example shows the use of overlap around the well.
require coarsegrid

%% What is overlap?
% Overlap means that we extend the support of the multiscale basis
% functions, that is, we include more fine cells when computing the basis
% function. Using overlapping domains enables capturing more complex flow
% patterns, particularly for very coarse grids, at the expense of increased
% coupling in the resulting systems of linear equations. The use of overlap
% is particularly attractive in cases of highly heterogeneous reservoirs of
% cases where wells are placed near the corner of a coarse well-block. In
% the following, we describe the different types of overlap implemented in
% the Matlab Reservoir Simulation Toolbox. Let the thick lines be the
% coarse grid, the thin lines represent the fine grid, the shaded region
% the overlap (of fine cells), and the red circle be the well.
%
% Overlap in the reservoir basis function for a coarse face ij means that
% we include fine cells around the the neighboring coarse blocks when we
% compute the basis for face ij:
%
% <<basisIJ.png>>
%
% The flow near a well is described by a multiscale well basis. This
% basis normally only has support in the coarse well-block. If the well
% lies close to the corner of the well-block, this will be a poor
% description of the flow near the well because it will not describe the
% flow over the corner. In such cases we can use overlap around
% the well ('overlapWell'), here shown in different colors with increasing
% number of overlap:
%
% <<basisOverlapWell.png>>
%
% In some cases (e.g in case of highly hetereogeneous permeability) it
% might be necessary to use overlap around the entire well block
% ('OverlapBlock'):
%
% <<basisOverlapBlock.png>>
%
%

%% Define and visualize the model
% We set up a simple 40-by-40-by-2 cartesian grid model with anisotropic,
% homogeneous permeability and assume that the reservoir is filled with a
% single fluid (with default values).
G         = cartGrid([40, 40, 2]);
G         = computeGeometry(G);
diag_k    = [500, 500, 50] .* milli*darcy;
rock.perm = repmat(diag_k, [G.cells.num, 1]);
fluid     = initSingleFluid('mu' ,    1*centi*poise     , ...
                            'rho', 1014*kilogram/meter^3);

gravity off

% Set two vertical wells.
W = verticalWell([], G, rock,  8,  8, 1:G.cartDims(3), ...
                 'Type', 'rate', 'Val', 1*meter^3/day, ...
                 'Radius', 0.1, 'Comp_i', [1, 0]);
W = verticalWell(W , G, rock, 33, 33, 1:G.cartDims(3), ...
                 'Type', 'bhp', 'Val', 0, 'Radius', 0.1, 'Comp_i', [0, 1]);

%% Partition the grid and compute mimetic innerproduct
% We partition the fine grid uniformly into 5-by-5-by-1 blocks using no
% overlap in the basis reservoir basis functions.
part = partitionCartGrid(G.cartDims, [5, 5, 1]);
CG   = generateCoarseGrid(G, part);
S    = computeMimeticIP(G, rock);

% Note: Only use overlap around wells, not in reservoir basisfunctions
mu  = fluid.properties(initResSol(G, 0.0));
kr  = fluid.relperm(ones([G.cells.num, 1]), initResSol(G, 0.0));
mob = kr ./ mu;
CS  = generateCoarseSystem(G, rock, S, CG, mob, 'Overlap', 0);

clf,
   plotCellData(G, mod(part,2), 'EdgeColor', 'k');
   outlineCoarseGrid(G, part, 'LineWidth', 3);
   plotWell(G, W, 'radius', 0.1, 'height', 2);
   view(3), axis tight off

%% Generate coarse well system with overlap around the well
% As can be seen from the plot of the model, the wells are near a corner of
% their supporting coarse blocks, which may lead to highly inaccurate
% results (as we will see shortly). To impreove the accuracy, we can
% introduce onverlap in the well basis functions. As pointed out above, we
% have two different choices: 'OverlapWell' and 'OverlapBlock'. The first
% includes cells around the well and the latter includes cells around the
% well-block (the coarse block containing the well). We apply overlap
% around the well for 'W1' and use no overlap for 'W' as a reference.
%
W1 = W;

% First no overlap
W  = generateCoarseWellSystem(G, S, CG, CS, mob, rock, W, ...
                              'OverlapWell',  0, 'OverlapBlock', 0);
% Then overlap around well
W1 = generateCoarseWellSystem(G, S, CG, CS, mob, rock, W1, ...
                              'OverlapWell', 10, 'OverlapBlock', 0);

%% Solve the global flow problems
%  The mass matrix B in the linear system will not be block-diagonal when
%  we use overlap. Thus, the lineary system system can not be reduced by
%  Schur-complement reduction as we do in the hybrid solver. Therefore, the
%  coarse system with overlap must be solved with option 'Solver', 'mixed'
%  as input to solveIncompFlowMS.

% Fine scale reference solution:
ref = initState(G, W, 0, [0, 1]);
ref = solveIncompFlow(ref, G, S, fluid, 'wells', W);

% Coarse scale - no overlap:
s = initState(G, W, 0, [1, 0]);
s = solveIncompFlowMS(s,  G, CG, part, S, CS, fluid, ...
                      'wells', W, 'Solver', 'mixed');

% Coarse scale - overlap:
s1 = initState(G, W, 0, [1, 0]);
s1 = solveIncompFlowMS(s1, G, CG, part, S, CS, fluid, ...
                       'wells', W1, 'Solver', 'mixed');

% Report pressure drop between wells.
dp = @(x) num2str(convertTo(x.wellSol(1).pressure, barsa()));
disp(['DeltaP - Fine:          ', dp(ref)])
disp(['DeltaP - Ms no overlap: ', dp(s  )])
disp(['DeltaP - Ms overlap:    ', dp(s1 )])


%% Plot solution
cellNo    = rldecode(1 : G.cells.num, diff(G.cells.facePos), 2) .';
diverg    = @(v) accumarray(cellNo, abs(convertTo(v, meter^3/day)));
plot_flux = @(x) plotCellData(G, diverg(x));
well_bas  = @(w) S.BI * sparse(w.CS.basis{1}{1}, 1, w.CS.basis{1}{3}, ...
                               size(G.cells.faces,1), 1);

subplot(2,3,1)
   plot_flux(ref.flux(G.cells.faces(:,1)));
   title('Flux - fine scale'); cx = caxis;

subplot(2,3,2)
   plot_flux(s.flux(G.cells.faces(:,1)))  ;
   title('Flux - no overlap'); caxis(cx)

subplot(2,3,3)
   plot_flux(s1.flux(G.cells.faces(:,1))) ;
   title('Flux - overlap')   ; caxis(cx)

subplot(2,3,5)
   plot_flux(well_bas(W(1)));
   axis([0, 20, 0, 20]);  cx = caxis;
   title('Well basis - no overlap')

subplot(2,3,6)
   plot_flux(well_bas(W1(1)));
   axis([0, 20, 0, 20]); caxis(cx);
   title('Well basis - overlap')

%%
displayEndOfDemoMessage(mfilename)

##### SOURCE END #####
--></body></html>